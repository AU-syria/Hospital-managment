<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الإشعارات</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="data:application/json;charset=utf-8,{%22name%22:%22تطبيق الإشعارات%22,%22short_name%22:%22إشعارات%22,%22start_url%22:%22./%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%236366f1%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' fill='%236366f1'/%3E%3Ctext x='96' y='120' font-size='80' text-anchor='middle' fill='white'%3E🔔%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .button {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 10px;
            min-width: 200px;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            word-break: break-word;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .form-group {
            margin: 15px 0;
            text-align: right;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374151;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            text-align: right;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            direction: ltr;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">🔔</div>
        <h1>اختبار الإشعارات</h1>

        <div id="status"></div>
        <div id="debug-info" class="debug-info"></div>

        <div class="form-group">
            <label for="notification-title">عنوان الإشعار:</label>
            <input type="text" id="notification-title" value="إشعار تجريبي" placeholder="أدخل العنوان">
        </div>
        
        <div class="form-group">
            <label for="notification-body">نص الإشعار:</label>
            <textarea id="notification-body" placeholder="أدخل النص">هذا اختبار للإشعارات</textarea>
        </div>

        <button id="check-support" class="button">فحص الدعم</button>
        <button id="request-permission" class="button">طلب الصلاحية</button>
        <button id="send-simple" class="button">إشعار بسيط</button>
        <button id="send-advanced" class="button" disabled>إشعار متقدم</button>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug-info');
        const titleInput = document.getElementById('notification-title');
        const bodyInput = document.getElementById('notification-body');

        // إظهار الرسائل
        function showStatus(message, type = 'success') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // إظهار معلومات التشخيص
        function showDebug(info) {
            debugDiv.innerHTML = `<strong>معلومات التشخيص:</strong><br>${info}`;
        }

        // فحص الدعم الكامل
        function checkSupport() {
            const info = [];
            
            info.push(`المتصفح: ${navigator.userAgent.split(' ').pop()}`);
            info.push(`البروتوكول: ${window.location.protocol}`);
            info.push(`النطاق: ${window.location.hostname}`);
            
            // فحص دعم الإشعارات
            if (!("Notification" in window)) {
                info.push(`❌ الإشعارات: غير مدعومة`);
                showStatus('المتصفح لا يدعم الإشعارات', 'error');
                showDebug(info.join('<br>'));
                return false;
            } else {
                info.push(`✅ الإشعارات: مدعومة`);
            }

            // فحص Service Worker
            if ('serviceWorker' in navigator) {
                info.push(`✅ Service Worker: مدعوم`);
            } else {
                info.push(`❌ Service Worker: غير مدعوم`);
            }

            // فحص الصلاحيات
            info.push(`صلاحية الإشعارات: ${Notification.permission}`);
            
            // فحص HTTPS
            if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
                info.push(`✅ HTTPS: نعم`);
            } else {
                info.push(`❌ HTTPS: لا - قد يسبب مشاكل`);
            }

            showDebug(info.join('<br>'));
            
            if (Notification.permission === 'granted') {
                showStatus('جميع المتطلبات متوفرة!', 'success');
                document.getElementById('send-advanced').disabled = false;
                return true;
            } else if (Notification.permission === 'denied') {
                showStatus('الإشعارات مرفوضة - يرجى تفعيلها من إعدادات المتصفح', 'error');
                return false;
            } else {
                showStatus('جاهز - يرجى طلب صلاحية الإشعارات', 'warning');
                return false;
            }
        }

        // طلب صلاحية الإشعارات
        async function requestPermission() {
            try {
                showStatus('جاري طلب الصلاحية...', 'warning');
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    showStatus('تم منح الصلاحية! 🎉', 'success');
                    document.getElementById('send-advanced').disabled = false;
                    checkSupport(); // تحديث معلومات التشخيص
                } else if (permission === 'denied') {
                    showStatus('تم رفض الصلاحية ❌', 'error');
                } else {
                    showStatus('لم يتم اتخاذ قرار', 'warning');
                }
            } catch (error) {
                showStatus(`خطأ: ${error.message}`, 'error');
                console.error('خطأ في طلب الصلاحية:', error);
            }
        }

        // إرسال إشعار بسيط (محاولة مع وبدون Service Worker)
        async function sendSimpleNotification() {
            if (Notification.permission !== 'granted') {
                showStatus('يرجى منح صلاحية الإشعارات أولاً', 'error');
                return;
            }

            const title = titleInput.value || 'إشعار تجريبي';
            const body = bodyInput.value || 'هذا اختبار بسيط للإشعارات';

            try {
                // محاولة إنشاء Service Worker بسيط أولاً
                const swCode = `
                    console.log('Service Worker مُحمل للإشعارات');
                    
                    self.addEventListener('notificationclick', event => {
                        console.log('تم النقر على الإشعار');
                        event.notification.close();
                        event.waitUntil(clients.openWindow('/'));
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                // تسجيل Service Worker
                const registration = await navigator.serviceWorker.register(swUrl);
                await navigator.serviceWorker.ready;

                // إرسال الإشعار عبر Service Worker
                await registration.showNotification(title, {
                    body: body,
                    tag: 'simple-test',
                    silent: false,
                    requireInteraction: false
                });

                showStatus('تم إرسال الإشعار عبر Service Worker! 📱', 'success');
                console.log('نجح إرسال الإشعار عبر Service Worker');

            } catch (swError) {
                console.error('فشل Service Worker، محاولة الطريقة التقليدية:', swError);
                
                try {
                    // محاولة الطريقة التقليدية كبديل
                    const notification = new Notification(title, {
                        body: body,
                        silent: false,
                        tag: 'simple-test'
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    showStatus('تم إرسال الإشعار بالطريقة التقليدية! 📱', 'success');

                    // إغلاق تلقائي بعد 5 ثواني
                    setTimeout(() => notification.close(), 5000);

                } catch (traditionalError) {
                    console.error('فشلت الطريقة التقليدية أيضاً:', traditionalError);
                    showStatus(`خطأ: ${traditionalError.message}`, 'error');
                    showStatus('متصفحك يتطلب Service Worker للإشعارات - جرب الإشعار المتقدم', 'warning');
                }
            }
        }

        // إرسال إشعار متقدم (عبر Service Worker مُحسّن)
        async function sendAdvancedNotification() {
            if (Notification.permission !== 'granted') {
                showStatus('يرجى منح صلاحية الإشعارات أولاً', 'error');
                return;
            }

            try {
                showStatus('جاري إعداد الإشعار المتقدم...', 'warning');

                // كود Service Worker محسّن
                const swCode = `
                    console.log('Service Worker متقدم مُحمل');
                    
                    // معالجة النقر على الإشعار
                    self.addEventListener('notificationclick', event => {
                        console.log('تم النقر على الإشعار المتقدم');
                        event.notification.close();
                        
                        event.waitUntil(
                            clients.matchAll({ type: 'window' }).then(clients => {
                                // إذا كان هناك نافذة مفتوحة، فعّلها
                                for (let client of clients) {
                                    if (client.url === self.registration.scope && 'focus' in client) {
                                        return client.focus();
                                    }
                                }
                                // وإلا افتح نافذة جديدة
                                if (clients.openWindow) {
                                    return clients.openWindow('/');
                                }
                            })
                        );
                    });
                    
                    // معالجة إغلاق الإشعار
                    self.addEventListener('notificationclose', event => {
                        console.log('تم إغلاق الإشعار:', event.notification.tag);
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                // إلغاء تسجيل Service Workers السابقة
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(registrations.map(reg => reg.unregister()));

                // تسجيل Service Worker جديد
                const registration = await navigator.serviceWorker.register(swUrl);
                console.log('تم تسجيل Service Worker:', registration);

                // انتظار جاهزية Service Worker
                await navigator.serviceWorker.ready;
                console.log('Service Worker جاهز');

                const title = titleInput.value || 'إشعار متقدم';
                const body = bodyInput.value || 'هذا إشعار متقدم عبر Service Worker';

                // إرسال الإشعار مع خيارات متقدمة
                await registration.showNotification(title, {
                    body: body,
                    tag: 'advanced-test-' + Date.now(),
                    silent: false,
                    requireInteraction: false,
                    vibrate: [200, 100, 200],
                    timestamp: Date.now(),
                    data: { 
                        url: window.location.href,
                        timestamp: Date.now() 
                    }
                });

                showStatus('تم إرسال الإشعار المتقدم بنجاح! 🚀', 'success');
                console.log('نجح إرسال الإشعار المتقدم');

                // تنظيف URL المؤقت
                setTimeout(() => URL.revokeObjectURL(swUrl), 1000);

            } catch (error) {
                console.error('خطأ في الإشعار المتقدم:', error);
                showStatus(`خطأ في الإشعار المتقدم: ${error.message}`, 'error');
                
                // إظهار تفاصيل إضافية للتشخيص
                const debugInfo = `
                    نوع الخطأ: ${error.name}<br>
                    الرسالة: ${error.message}<br>
                    السطر: ${error.stack ? error.stack.split('\\n')[1] : 'غير معروف'}
                `;
                showDebug(debugInfo);
            }
        }

        // ربط الأحداث
        document.getElementById('check-support').addEventListener('click', checkSupport);
        document.getElementById('request-permission').addEventListener('click', requestPermission);
        document.getElementById('send-simple').addEventListener('click', sendSimpleNotification);
        document.getElementById('send-advanced').addEventListener('click', sendAdvancedNotification);

        // فحص تلقائي عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            checkSupport();
            showStatus('مرحباً! ابدأ بفحص الدعم', 'success');
        });
    </script>
</body>
</html>
